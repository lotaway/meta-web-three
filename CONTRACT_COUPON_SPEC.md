# Contract Coupon方案说明

本文整理在 `GoodsNFT.sol` 商品售卖场景下，如何实现优惠券且避免卖家为每次发券支付高额手续费。

## 目标与约束
1. 卖家不应为每张优惠券上链付费。
2. 用户购买时可以使用优惠券折扣。
3. 优惠券可防止重复使用与伪造。
4. 兼容链上售卖流程，不引入过多状态写入。

## 方案一：离链发券 + EIP-712签名核销（推荐）

**核心思路**：优惠券由卖家在链下生成并签名，买家在购买时提交签名，合约验证后应用折扣。

**流程**
1. 卖家后端生成优惠券结构：`couponId、discount、minPrice、expiry、nonce`。
2. 卖家使用私钥对结构进行 EIP-712 签名。
3. 买家购买时提交优惠券数据与签名。
4. 合约验证签名、有效期、未被使用。
5. 通过 `mapping(couponId => used)` 防重复。

**优点**
1. 卖家不需要为每张券上链付费。
2. 只在使用时写链，成本由买家承担。
3. 不依赖链下数据库即可校验真实性。

**缺点**
1. 需要后端生成签名。
2. 需要管理 `couponId` 或 `nonce` 防止重放。

**适用场景**
1. 优惠券动态生成。
2. 低频发券。

## 方案二：Merkle树白名单优惠券

**核心思路**：优惠券列表在链下生成并做 Merkle Root，上链只存 Root，用户购买时提交 Proof。

**流程**
1. 卖家链下生成优惠券名单：地址 + 折扣 + 规则。
2. 生成 Merkle Root，上链存一次。
3. 用户购买时提交 Merkle Proof。
4. 合约验证 Proof 后应用折扣。

**优点**
1. 上链一次即可覆盖大量优惠券。
2. 成本低，适合批量发券。

**缺点**
1. 单券撤销困难，需要更新 Root。
2. 需要管理 Proof 生成与发放。

**适用场景**
1. 大规模、批量发券。
2. 优惠券规则相对稳定。

## 方案三：链上券类型 + 离链券码

**核心思路**：链上只存优惠券类型与规则，券码实际离链发放，使用时通过签名验证。

**流程**
1. 卖家在链上创建优惠券类型（一次性成本）。
2. 券码列表在链下发放与管理。
3. 使用时提交券码签名给合约核验。

**优点**
1. 规则透明可审计。
2. 卖家成本集中在类型创建。

**缺点**
1. 仍需链下生成与管理券码。
2. 需要维护类型与签名绑定关系。

**适用场景**
1. 有固定优惠券规则。
2. 需要链上公开规则。

## 方案四：Meta-Transaction + Paymaster

**核心思路**：用户提交交易，但由 Paymaster 代付 gas。

**优点**
1. 用户无感支付 gas。

**缺点**
1. 成本仍然被平台或卖家承担。
2. 不符合“卖家不额外付费”的约束。

**适用场景**
1. 平台愿意补贴 gas。
2. 追求无门槛用户体验。

## 推荐结论
1. **优先推荐**：离链发券 + EIP-712 签名核销。
2. **批量发券场景**：Merkle Root 白名单方案。
3. **规则透明化**：链上券类型 + 离链券码。

## 与 `GoodsNFT.sol` 集成建议
1. 折扣校验与核销放在 `buy` 或 `mint` 流程中。
2. 仅在使用优惠券时写链标记 `used`。
3. 优惠券结构中应包含最小支付金额与过期时间。


# Contract Coupon签名方案对比

## 目标
为优惠券在链上验证时选择合适的签名规范，确保安全性、可维护性、可审计性。

## EIP-191

**优点**
1. 实现简单，签名与验签代码短。
2. 兼容性高，几乎所有钱包与 SDK 都支持。
3. 适合简单消息或低风险授权场景。

**缺点**
1. 签名数据是“原始字节串”，结构只存在于约定中。
2. JSON 等字符串序列化存在多种格式，签名易因格式差异失效。
3. 缺少强类型字段与 domain separator，容易出现跨合约或跨链重放。
4. 对业务审计不友好，签名内容不可结构化展示。

**适用场景**
1. 签名内容简单。
2. 风险较低且不需要复杂业务字段。

## EIP-712

**优点**
1. 强类型结构化字段，数据一致性强。
2. 内置 domain separator（链 ID、合约地址、版本），天然防重放。
3. 钱包显示可读性强，方便审计与合规。
4. 适合复杂业务参数的授权。

**缺点**
1. 实现复杂度比 EIP-191 高。
2. 前后端需要严格同步结构定义。
3. 客户端开发门槛略高。

**适用场景**
1. 涉及金额、权限、条件、有效期等复杂字段。
2. 高风险或高价值业务。
3. 需要长期维护与合规审计。

## 选择建议
1. 优惠券属于结构化业务数据，推荐使用 **EIP-712**。
2. 若只做非常轻量的文本授权，可考虑 **EIP-191**。
