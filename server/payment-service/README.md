# Payment Service

法币兑换数字币微服务，提供完整的法币与数字资产兑换功能。

## 功能特性

### 1. 法币支付接入层

- 支持支付宝、微信支付、银行转账、Apple Pay、Google Pay
- 多种支付渠道的统一下单接口
- 支付回调处理和状态同步
- 国际化支持（中英文翻译）

### 2. 实时报价引擎

- 多交易所价格聚合（Binance、Coinbase、OKX）
- 加权平均价格计算
- 秒级价格更新
- 价格缓存机制

### 3. 订单撮合与兑换系统

- 支持法币购买数字币和数字币兑换法币
- 实时汇率锁定
- 滑点控制
- 自动撮合执行
- 对账服务（每日自动对账）
- 结算服务（T+1 结算）

### 4. 钱包与资金账户

- 热钱包和冷钱包管理
- 多币种支持（BTC、ETH、USDT、USDC）
- 区块链交易执行和确认

### 5. 订单状态同步

- 实时订单状态跟踪
- 支付状态同步
- 区块链交易确认

### 6. 合规与风控模块

- KYC 级别验证
- 交易限额控制
- 异常行为检测
- 地址风险检查
- 自动对账差异检测
- 结算金额计算

## 技术架构

### 核心组件

- **ExchangeOrderService**: 兑换订单核心服务
- **PriceEngineService**: 价格引擎服务
- **RiskControlService**: 风控服务
- **PaymentService**: 支付服务
- **CryptoWalletService**: 数字钱包服务
- **ExternalPriceService**: 外部价格服务
- **ReconciliationService**: 对账服务
- **SettlementService**: 结算服务

### 数据模型

- **ExchangeOrder**: 兑换订单实体
- **CryptoPrice**: 加密货币价格实体
- **UserKYC**: 用户 KYC 实体
- **ClearingSummary**: 清分汇总实体
- **SettlementRecord**: 结算记录实体

### 数据访问层

- **MyBatis Plus**: 使用 MyBatis Plus 进行数据访问
- **Mapper 接口**: 继承 BaseMapper，提供基础 CRUD 操作
- **XML 映射**: 支持复杂 SQL 查询和结果映射
- **自动填充**: 支持创建时间和更新时间的自动填充

## 部署说明

### 1. 数据库初始化

```sql
-- 执行 src/main/resources/db/init.sql
```

## 业务流程

### 法币购买数字币流程

1. 用户发起购买请求
2. 系统验证 KYC 级别和风控规则
3. 获取实时价格并计算兑换数量
4. 创建兑换订单
5. 生成支付链接
6. 用户完成支付
7. 系统确认支付并执行数字资产转账
8. 每日自动对账
9. T+1 结算
10. 订单完成

### 数字币兑换法币流程

1. 用户发起兑换请求
2. 系统验证 KYC 级别和风控规则
3. 获取实时价格并计算法币金额
4. 创建兑换订单
5. 用户转账数字资产到系统钱包
6. 系统确认到账并执行法币转账
7. 每日自动对账
8. T+1 结算
9. 订单完成

## 监控和日志

### 关键指标

- 订单成功率
- 平均处理时间
- 价格更新频率
- 支付成功率
- 风控拦截率

### 日志级别

- DEBUG: 详细调试信息
- INFO: 业务操作日志
- WARN: 警告信息
- ERROR: 错误信息

## 安全考虑

### 数据安全

- 敏感数据加密存储
- 支付信息脱敏
- 访问日志记录

### 接口安全

- JWT 身份验证
- 请求签名验证
- 频率限制
- IP 白名单

### 风控安全

- 实时风控检测
- 异常行为识别
- 黑名单机制
- 限额控制

## 扩展性

### 支持新币种

1. 在配置中添加新币种
2. 实现对应的钱包服务
3. 添加价格源支持

### 支持新支付方式

1. 实现支付接口
2. 添加回调处理
3. 更新配置

### 支持新交易所

1. 实现价格获取接口
2. 添加权重配置
3. 更新价格聚合逻辑
